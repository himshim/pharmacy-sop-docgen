<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional SOP Document Generator for Pharmacy Education - ISO, PCI, NAAC Compliant">
    <meta name="keywords" content="SOP, Standard Operating Procedure, Pharmacy, Document Generator, ISO, PCI, NAAC">
    <meta name="author" content="@himshim26">
    <meta name="theme-color" content="#667eea">
    <title>SOP Generator - Professional Document Creator</title>

    <style>
        /* ==================== PRINT STYLES ==================== */
        @media print {
            body * {
                visibility: hidden !important;
            }

            #preview,
            #preview *,
            #preview-content,
            #preview-content * {
                visibility: visible !important;
            }

            #preview {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                padding: 20mm !important;
                margin: 0 !important;
                background: white !important;
            }

            @page {
                size: A4 portrait;
                margin: 0;
            }

            * {
                background: white !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                font-size: 12pt !important;
                line-height: 1.5 !important;
                color: black !important;
                font-family: 'Times New Roman', Times, serif !important;
            }

            h1 { font-size: 18pt !important; page-break-after: avoid; }
            h2 { font-size: 16pt !important; page-break-after: avoid; }
            h3 { font-size: 14pt !important; page-break-after: avoid; }

            table { page-break-inside: avoid; border-collapse: collapse !important; }
            td, th { border: 1px solid #000 !important; padding: 8px !important; }

            .no-print, header, footer, .sidebar, .controls, 
            .tabs, button, input, select, textarea, nav {
                display: none !important;
            }
        }

        /* ==================== BASE STYLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 
                         'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }

        /* ==================== LOADING SCREEN ==================== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
            color: white;
            padding: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-content p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* ==================== ERROR SCREEN ==================== */
        .error-content {
            text-align: center;
            color: white;
            padding: 30px;
            max-width: 500px;
        }

        .error-content h2 {
            font-size: 2rem;
            margin-bottom: 16px;
        }

        .error-content p {
            font-size: 1rem;
            opacity: 0.95;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .error-content button {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .error-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* ==================== UI CONTAINER ==================== */
        #ui-container {
            opacity: 0;
            transition: opacity 0.5s ease;
            min-height: 100vh;
        }

        #ui-container.loaded {
            opacity: 1;
        }

        /* ==================== RESPONSIVE UI SWITCHING ==================== */
        @media (min-width: 769px) {
            #ui-mobile { 
                display: none !important; 
            }
        }

        @media (max-width: 768px) {
            #ui-desktop { 
                display: none !important; 
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>Loading SOP Generator...</h2>
            <p>Preparing your professional workspace</p>
        </div>
    </div>

    <!-- UI Container -->
    <div id="ui-container">
        <!-- Desktop UI (loaded dynamically) -->
        <div id="ui-desktop"></div>

        <!-- Mobile UI (loaded dynamically) -->
        <div id="ui-mobile"></div>
    </div>

    <!-- Core Scripts -->
    <script src="js/template-engine.js"></script>
    <script src="js/sop-engine.js"></script>

    <!-- Main Application Script -->
    <script>
        'use strict';

        // ==================== CONSTANTS ====================
        const MOBILE_BREAKPOINT = 768;
        const LOAD_TIMEOUT = 10000;
        const RETRY_DELAY = 1000;

        // ==================== UTILITY FUNCTIONS ====================
        function isMobile() {
            return window.innerWidth <= MOBILE_BREAKPOINT;
        }

        function showError(message, details = '') {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.innerHTML = `
                <div class="error-content">
                    <h2>‚ö†Ô∏è Error Loading Application</h2>
                    <p><strong>${message}</strong></p>
                    ${details ? `<p>${details}</p>` : ''}
                    <p>Please check your internet connection and try again.</p>
                    <button onclick="location.reload()">üîÑ Reload Page</button>
                </div>
            `;
        }

        // ==================== EVENT LISTENER ATTACHMENT ====================
        function attachEventListeners() {
            console.log('üéØ Attaching event listeners...');

            // === Mobile UI: Tab Switching ===
            const tabButtons = document.querySelectorAll('.tab-btn, [data-tab]');
            if (tabButtons.length > 0) {
                tabButtons.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const targetTab = this.getAttribute('data-tab') || this.dataset.tab;

                        if (!targetTab) {
                            console.warn('‚ö†Ô∏è Tab button missing data-tab attribute');
                            return;
                        }

                        console.log(`üìë Switching to tab: ${targetTab}`);

                        document.querySelectorAll('.tab-btn, [data-tab]').forEach(t => {
                            t.classList.remove('active');
                        });
                        document.querySelectorAll('.tab-content, .tab-panel').forEach(c => {
                            c.classList.remove('active');
                        });

                        this.classList.add('active');
                        const targetContent = document.getElementById(targetTab) || 
                                            document.getElementById('tab-' + targetTab);
                        if (targetContent) {
                            targetContent.classList.add('active');
                            console.log(`‚úÖ Tab ${targetTab} activated`);
                        } else {
                            console.error(`‚ùå Tab content #${targetTab} not found`);
                        }
                    });
                });
                console.log(`‚úÖ Attached listeners to ${tabButtons.length} tab buttons`);
            }

            // === Print Button Handler ===
            const printButtons = document.querySelectorAll(
                '.print-btn, #print-btn, [onclick*="print"], button'
            );

            printButtons.forEach(btn => {
                const btnText = (btn.textContent || btn.innerText || '').toLowerCase();
                if (btnText.includes('print') || btnText.includes('üñ®Ô∏è')) {
                    btn.removeAttribute('onclick');
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);

                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üñ®Ô∏è Print button clicked');

                        const preview = document.getElementById('preview');
                        if (preview && preview.innerHTML.trim()) {
                            window.print();
                        } else {
                            alert('‚ö†Ô∏è Please select a department and SOP first to preview the document.');
                        }
                    });
                }
            });

            console.log('‚úÖ Event listeners attached successfully');
        }

        // ==================== UI LOADING WITH RETRY ====================
        async function loadUIWithRetry(retries = 3) {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    console.log(`üîÑ Load attempt ${attempt}/${retries}`);
                    await loadUI();
                    return;
                } catch (error) {
                    console.error(`‚ùå Attempt ${attempt} failed:`, error);

                    if (attempt === retries) {
                        throw error;
                    }

                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                }
            }
        }

        async function loadUI() {
            console.log('üöÄ Starting UI load...');

            const mobile = isMobile();
            const uiFile = mobile ? 'partials/ui-mobile.html' : 'partials/ui-desktop.html';
            const targetDiv = mobile ? 'ui-mobile' : 'ui-desktop';

            console.log(`üì± Device: ${mobile ? 'Mobile' : 'Desktop'} (${window.innerWidth}px)`);
            console.log(`üìÑ Loading: ${uiFile}`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), LOAD_TIMEOUT);

            try {
                const response = await fetch(uiFile, {
                    signal: controller.signal,
                    cache: 'no-cache'
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to load ${uiFile}`);
                }

                const html = await response.text();
                console.log(`‚úÖ Loaded ${html.length} bytes from ${uiFile}`);

                const targetElement = document.getElementById(targetDiv);
                if (!targetElement) {
                    throw new Error(`Target element #${targetDiv} not found in DOM`);
                }

                targetElement.innerHTML = html;
                console.log('‚úÖ UI injected into DOM');

                await new Promise(resolve => setTimeout(resolve, 100));

                if (typeof window.initSOPApp === 'function') {
                    console.log('‚öôÔ∏è Initializing SOP App...');
                    window.initSOPApp();
                } else {
                    console.warn('‚ö†Ô∏è initSOPApp function not found - check if sop-engine.js loaded');
                }

                attachEventListeners();

                setTimeout(() => {
                    const loadingScreen = document.getElementById('loadingScreen');
                    const uiContainer = document.getElementById('ui-container');

                    if (loadingScreen) loadingScreen.classList.add('hidden');
                    if (uiContainer) uiContainer.classList.add('loaded');

                    console.log('‚úÖ UI loaded successfully');
                }, 300);

            } catch (error) {
                clearTimeout(timeoutId);

                if (error.name === 'AbortError') {
                    throw new Error('Request timeout - Server took too long to respond');
                }

                throw error;
            }
        }

        // ==================== ORIENTATION/RESIZE HANDLER ====================
        let resizeTimer;
        function handleResize() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                const desktopLoaded = document.getElementById('ui-desktop').innerHTML !== '';
                const mobileLoaded = document.getElementById('ui-mobile').innerHTML !== '';
                const currentlyMobile = isMobile();

                if ((currentlyMobile && desktopLoaded) || (!currentlyMobile && mobileLoaded)) {
                    console.log('üîÑ Device type changed, reloading UI...');
                    location.reload();
                }
            }, 250);
        }

        // ==================== INITIALIZATION ====================
        async function init() {
            try {
                await loadUIWithRetry(3);
            } catch (error) {
                console.error('‚ùå Fatal error loading UI:', error);
                showError(
                    error.message || 'Failed to load application',
                    'This could be due to network issues or missing files.'
                );
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        window.addEventListener('resize', handleResize);

        // ==================== PRINT HANDLERS ====================
        window.addEventListener('beforeprint', function() {
            console.log('üñ®Ô∏è Print dialog opened');
        });

        window.addEventListener('afterprint', function() {
            console.log('‚úÖ Print dialog closed');
        });

        // ==================== GLOBAL ERROR HANDLING ====================
        window.addEventListener('error', function(e) {
            console.error('‚ùå Global error:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('‚ùå Unhandled promise rejection:', e.reason);
        });

        // ==================== EXPORT FOR DEBUGGING ====================
        window.sopApp = {
            version: '2.0.0',
            isMobile: isMobile,
            reload: () => location.reload(),
            attachListeners: attachEventListeners
        };

        console.log('üì¶ SOP Generator v2.0.0 initialized');
    </script>
</body>
</html>
