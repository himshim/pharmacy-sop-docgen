<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>SOP Generator - Mobile</title>
    <link rel="stylesheet" href="../css/ui-mobile.css" />
    <link rel="stylesheet" href="../css/print-a4.css" />

    <!-- Word Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-docx-js@0.3.1/dist/html-docx.js"></script>
  </head>
  <body class="mobile-ui">
    <header class="mobile-header">
      <div class="header-content">
        <h1><span class="logo-badge">ğŸ“‹</span> SOP Generator</h1>
        <p>Professional Standard Operating Procedures</p>
        <span class="header-badge">Pharma Edition</span>
      </div>
    </header>

    <nav class="tab-navigation">
      <button class="tab-btn active" onclick="switchTab(0)">ğŸ“ Create</button>
      <button class="tab-btn" onclick="switchTab(1)">ğŸ‘ï¸ Preview</button>
      <button class="tab-btn" onclick="switchTab(2)">âš™ï¸ Settings</button>
    </nav>

    <div class="mobile-content">
      <!-- TAB 1: CREATE -->
      <div class="tab-panel active" id="tab-create">
        <!-- Selection Card -->
        <div class="card">
          <h2 class="card-title">ğŸ“ Selection</h2>
          <div class="form-group">
            <label for="departmentSelect">Department</label>
            <select id="departmentSelect">
              <option value="">Choose department...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="sopSelect">SOP Document</label>
            <select id="sopSelect" disabled>
              <option value="">Choose SOP...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="templateSelect">Template Style</label>
            <select id="templateSelect">
              <option value="sop-a4-classic">Classic</option>
              <option value="sop-a4-iso">ISO</option>
              <option value="sop-a4-naac">NAAC</option>
              <option value="sop-a4-pci">PCI</option>
              <option value="sop-a4-master-professional">Master Professional (QA)</option>
            </select>
          </div>
        </div>

        <!-- Document Info Card -->
        <div class="card" id="sectionDocControl">
          <h2 class="card-title">ğŸ“‹ Document Info</h2>
          <div class="form-group">
            <label for="institute">Institute</label>
            <input type="text" id="institute" placeholder="Institute name" />
          </div>
          <div class="form-group">
            <label for="department">Department</label>
            <input type="text" id="department" placeholder="Department" />
          </div>
          <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" placeholder="SOP title" />
          </div>
          <div class="form-group">
            <label for="sopNumber">SOP Number</label>
            <input type="text" id="sopNumber" placeholder="e.g., SOP-001" />
          </div>
          <div class="form-group">
            <label for="revisionNo">Revision No.</label>
            <input type="text" id="revisionNo" placeholder="00" />
          </div>
          <div class="form-group">
            <label for="effectiveDate">Effective Date</label>
            <input type="date" id="effectiveDate" />
          </div>
          <div class="form-group">
            <label for="revisionDate">Revision Date</label>
            <input type="date" id="revisionDate" />
          </div>
          <div class="form-group">
            <label for="nextReviewDate">Next Review</label>
            <input type="date" id="nextReviewDate" />
          </div>
          <div class="form-group">
            <label for="copyType">Copy Type</label>
            <select id="copyType">
              <option value="CONTROLLED">Controlled</option>
              <option value="UNCONTROLLED">Uncontrolled</option>
            </select>
          </div>
        </div>

        <!-- Content Card -->
        <div class="card">
          <h2 class="card-title">ğŸ“ Content</h2>

          <div class="expandable">
            <div class="expandable-header" onclick="toggleExpand(this)">
              <h3>Purpose</h3>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="expandable-content">
              <textarea
                id="purpose"
                placeholder="Describe the purpose..."
              ></textarea>
            </div>
          </div>

          <div class="expandable">
            <div class="expandable-header" onclick="toggleExpand(this)">
              <h3>Scope</h3>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="expandable-content">
              <textarea id="scope" placeholder="Define the scope..."></textarea>
            </div>
          </div>

          <div class="expandable">
            <div class="expandable-header" onclick="toggleExpand(this)">
              <h3>Responsibility</h3>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="expandable-content">
              <textarea
                id="responsibility"
                placeholder="List responsibilities..."
              ></textarea>
            </div>
          </div>

          <div class="expandable">
            <div class="expandable-header" onclick="toggleExpand(this)">
              <h3>Procedure</h3>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="expandable-content">
              <textarea
                id="procedure"
                placeholder="Steps (one per line)..."
              ></textarea>
            </div>
          </div>

          <div class="expandable">
            <div class="expandable-header" onclick="toggleExpand(this)">
              <h3>Precautions</h3>
              <span class="expand-icon">â–¼</span>
            </div>
            <div class="expandable-content">
              <textarea
                id="precautions"
                placeholder="Safety precautions..."
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Applicability Card -->
        <div class="card" id="sectionApplicability" style="display: none">
          <h2 class="card-title">ğŸ¯ Applicability</h2>
          <textarea
            id="applicability"
            placeholder="Define applicability..."
          ></textarea>
        </div>

        <!-- Abbreviations Card -->
        <div class="card" id="sectionAbbreviations" style="display: none">
          <h2 class="card-title">ğŸ“– Abbreviations</h2>
          <textarea
            id="abbreviations"
            placeholder="List abbreviations..."
          ></textarea>
        </div>

        <!-- References Card -->
        <div class="card" id="sectionReferences" style="display: none">
          <h2 class="card-title">ğŸ“š References</h2>
          <textarea id="references" placeholder="List references..."></textarea>
        </div>

        <!-- Annexures Card -->
        <div class="card" id="sectionAnnexures" style="display: none">
          <h2 class="card-title">ğŸ“ Annexures</h2>
          <textarea id="annexures" placeholder="List annexures..."></textarea>
        </div>

        <!-- Change History Card -->
        <div class="card" id="sectionChangeHistory" style="display: none">
          <h2 class="card-title">ğŸ“œ Change History</h2>
          <textarea
            id="changeHistoryInput"
            placeholder="Format: Version|Date|Changes|Approved By"
          ></textarea>
        </div>

        <!-- Approval Card -->
        <div class="card">
          <h2 class="card-title">âœï¸ Approval</h2>

          <div class="subsection-title">Prepared By</div>
          <div class="form-group">
            <label for="preparedBy">Name</label>
            <input type="text" id="preparedBy" placeholder="Full name" />
          </div>
          <div class="form-group">
            <label for="preparedDesig">Designation</label>
            <input type="text" id="preparedDesig" placeholder="Job title" />
          </div>
          <div class="form-group">
            <label for="preparedDate">Date</label>
            <input type="date" id="preparedDate" />
          </div>

          <div class="subsection-title">Checked By</div>
          <div class="form-group">
            <label for="checkedBy">Name</label>
            <input type="text" id="checkedBy" placeholder="Full name" />
          </div>
          <div class="form-group">
            <label for="checkedDesig">Designation</label>
            <input type="text" id="checkedDesig" placeholder="Job title" />
          </div>
          <div class="form-group">
            <label for="checkedDate">Date</label>
            <input type="date" id="checkedDate" />
          </div>

          <div class="subsection-title">Approved By</div>
          <div class="form-group">
            <label for="approvedBy">Name</label>
            <input type="text" id="approvedBy" placeholder="Full name" />
          </div>
          <div class="form-group">
            <label for="approvedDesig">Designation</label>
            <input type="text" id="approvedDesig" placeholder="Job title" />
          </div>
          <div class="form-group">
            <label for="approvedDate">Date</label>
            <input type="date" id="approvedDate" />
          </div>
        </div>

        <!-- Credit Badge -->
        <div class="credit-badge">
          <p>Developed by</p>
          <a href="https://github.com/himshim" target="_blank">@himshim26</a>
        </div>
      </div>

      <!-- TAB 2: PREVIEW -->
      <div class="tab-panel" id="tab-preview">
        <div class="card">
          <h2 class="card-title">ğŸ“„ Document Preview</h2>
          <div id="preview-wrapper">
            <div id="preview">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‚</div>
                <p>Select a department and SOP<br />to preview your document</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 3: SETTINGS (Toggles) -->
      <div class="tab-panel" id="tab-options">
        <!-- Section Visibility -->
        <div class="card">
          <h2 class="card-title">ğŸ‘ï¸ Section Visibility</h2>
          <div class="toggle-list">
            <div class="toggle-item">
              <label for="toggleDocControl">Document Control</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleDocControl" checked />
                <span class="slider"></span>
              </div>
            </div>
            <div class="toggle-item">
              <label for="toggleApplicability">Applicability</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleApplicability" />
                <span class="slider"></span>
              </div>
            </div>
            <div class="toggle-item">
              <label for="toggleAbbreviations">Abbreviations</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleAbbreviations" />
                <span class="slider"></span>
              </div>
            </div>
            <div class="toggle-item">
              <label for="toggleReferences">References</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleReferences" />
                <span class="slider"></span>
              </div>
            </div>
            <div class="toggle-item">
              <label for="toggleAnnexures">Annexures</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleAnnexures" />
                <span class="slider"></span>
              </div>
            </div>
            <div class="toggle-item">
              <label for="toggleChangeHistory">Change History</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleChangeHistory" />
                <span class="slider"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Field Visibility -->
        <div class="card">
          <h2 class="card-title">ğŸ”§ Field Visibility</h2>
          <div class="toggle-list">
            <div class="toggle-item">
              <label for="toggleSopNumber">SOP Number</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleSopNumber" checked />
                <span class="slider"></span>
              </div>
            </div>
            <div class="toggle-item">
              <label for="toggleEffectiveDate">Effective Date</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleEffectiveDate" checked />
                <span class="slider"></span>
              </div>
            </div>
            <div class="toggle-item">
              <label for="toggleRevisionDate">Revision Date</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleRevisionDate" checked />
                <span class="slider"></span>
              </div>
            </div>
            <div class="toggle-item">
              <label for="toggleCopyType">Copy Type</label>
              <div class="toggle-switch">
                <input type="checkbox" id="toggleCopyType" checked />
                <span class="slider"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Credit -->
        <div class="credit-badge">
          <p>Created by</p>
          <a href="https://github.com/himshim" target="_blank">@himshim26</a>
        </div>
      </div>
    </div>

    <!-- Bottom Action Bar -->
    <div class="bottom-action-bar">
      <button class="action-btn btn-secondary" onclick="window.print()">
        ğŸ–¨ï¸ Print
      </button>
      <button id="print-btn" class="action-btn btn-primary">ğŸ’¾ Save PDF</button>
    </div>

    <!-- html2pdf.js Library -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
      integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <!-- Tab Switching & Expand Functions -->
    <script>
      function switchTab(index) {
        const tabs = document.querySelectorAll(".tab-btn");
        const panels = document.querySelectorAll(".tab-panel");

        tabs.forEach((tab, i) => {
          tab.classList.toggle("active", i === index);
        });

        panels.forEach((panel, i) => {
          panel.classList.toggle("active", i === index);
        });
      }

      function toggleExpand(header) {
        const expandable = header.parentElement;
        expandable.classList.toggle("open");
      }


    </script>

    <!-- SOP Engine -->
<script src="../js/sop-engine.js"></script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- EXPORT FUNCTIONALITY FIX - Universal WYSIWYG Export for All Templates  -->
<!-- Handles: Classic, PCI, NAAC, ISO templates                              -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
(function() {
  'use strict';
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HELPER: Extract Document Title (Works with ALL 4 templates)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function getDocumentTitle() {
    const preview = document.getElementById('preview');
    if (!preview) return 'SOP_Document';
    
    let title = '';
    
    // Strategy 1: Look for value-cell class (PCI/NAAC/ISO templates)
    const valueCell = preview.querySelector('.value-cell');
    if (valueCell && valueCell.textContent.trim()) {
      title = valueCell.textContent.trim();
    }
    
    // Strategy 2: Look for title in table (Classic template)
    if (!title) {
      const tableTitle = preview.querySelector('table td b');
      if (tableTitle) {
        title = tableTitle.textContent.trim();
      }
    }
    
    // Strategy 3: Look for any bold text in first table cell
    if (!title) {
      const firstBold = preview.querySelector('b, strong');
      if (firstBold) {
        title = firstBold.textContent.trim();
      }
    }
    
    // Strategy 4: Look for h1
    if (!title) {
      const h1 = preview.querySelector('h1');
      if (h1) {
        title = h1.textContent.trim();
      }
    }
    
    // Fallback
    if (!title) {
      title = 'SOP_Document';
    }
    
    // Clean title for filename (remove special chars, limit length)
    return title
      .replace(/[^a-zA-Z0-9\s-]/g, '')
      .replace(/\s+/g, '_')
      .substring(0, 100) || 'SOP_Document';
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INITIALIZATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  window.addEventListener('load', function() {
    
    // Wait for sop-engine.js initialization
    setTimeout(function() {
      
      console.log('ğŸ”§ Initializing Universal Export Handlers...');
      
      // Verify ExportModule exists
      if (typeof window.ExportModule === 'undefined') {
        console.error('âŒ ExportModule not found! Check if sop-engine.js loaded.');
        return;
      }
      
      const preview = document.getElementById('preview');
      if (!preview) {
        console.warn('âš ï¸ #preview element not found');
      }
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 1. FIX PRINT BUTTON
      // Replace native window.print() with ExportModule.print()
      // (adds printing-mode class for better CSS control)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const printButtons = document.querySelectorAll('button[onclick*="window.print"]');
      printButtons.forEach(function(btn) {
        btn.removeAttribute('onclick');
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('ğŸ–¨ï¸ Print via ExportModule (adds printing-mode class)');
          window.ExportModule.print();
        });
        console.log('âœ“ Print button â†’ ExportModule.print()');
      });
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 2. FIX PDF BUTTON  
      // Connect to ExportModule.exportPDF() with smart filename
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const pdfBtn = document.getElementById('print-btn');
      if (pdfBtn) {
        pdfBtn.addEventListener('click', function() {
          const title = getDocumentTitle();
          const filename = title + '.pdf';
          console.log('ğŸ“„ PDF Export: ' + filename);
          window.ExportModule.exportPDF(filename);
        });
        console.log('âœ“ PDF button â†’ ExportModule.exportPDF()');
      } else {
        console.warn('âš ï¸ PDF button (id="print-btn") not found in HTML');
      }
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 3. ENSURE WORD BUTTON EXISTS
      // Create if missing, attach event handler
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function ensureWordButton() {
        let docxBtn = document.getElementById('docx-btn');
        
        if (!docxBtn) {
          // Create button if UIModule didn't
          const toolbar = document.querySelector('.toolbar-buttons');
          if (toolbar) {
            docxBtn = document.createElement('button');
            docxBtn.id = 'docx-btn';
            docxBtn.className = pdfBtn ? pdfBtn.className : 'btn-primary';
            docxBtn.innerHTML = 'ğŸ“ Export to Word';
            docxBtn.title = 'Export as editable Word document (.docx)';
            toolbar.appendChild(docxBtn);
            console.log('âœ“ Word button created');
          }
        }
        
        if (docxBtn && !docxBtn.hasAttribute('data-handler-attached')) {
          docxBtn.addEventListener('click', function() {
            const title = getDocumentTitle();
            const filename = title + '.docx';
            console.log('ğŸ“ Word Export: ' + filename);
            window.ExportModule.exportDOCX(filename);
          });
          docxBtn.setAttribute('data-handler-attached', 'true');
          console.log('âœ“ Word button â†’ ExportModule.exportDOCX()');
        }
      }
      
      // Try immediately
      ensureWordButton();
      
      // Try again after 1 second (in case UI loads slowly)
      setTimeout(ensureWordButton, 1000);
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 4. VERIFICATION
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      console.log('âœ… Universal Export initialized!');
      console.log('   â†’ Works with: Classic, PCI, NAAC, ISO templates');
      console.log('   â†’ WYSIWYG: What you see is what you export');
      
    }, 500); // Wait for sop-engine.js initialization
  });
})();
</script>

  </body>
</html>